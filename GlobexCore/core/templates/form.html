{% extends "layouts/base.html" %}

{% block title %} FORM {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
{% load filters %}
{% load crispy_forms_tags %}
    <!-- [ Main Content ] start -->
    <div class="pcoded-main-container">
        <div class="pcoded-wrapper">

            <div class="pcoded-content">
                <div class="pcoded-inner-content">
                    <div class="main-body">
                        <div class="page-wrapper">
                            <!-- [ Main Content ] start -->
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Basic Component</h5>
                                        </div>
                                        <div class="card-body">
                                            <h5>Form controls</h5>
                                            <hr>
                                            <form method="POST">
                                                {% csrf_token %}
                                                <div class="form-group">
                                                    {{ form |crispy}}
                                                </div>

                                                <!-- Inline Formsets -->
                                                <div id="formset-container">
                                                    {% for inline_formset in inline_formsets %}
                                                        <div class="form-group">
                                                            {{ inline_formset.management_form }}
                                                            {% for form in inline_formset %}
                                                                <div class="form-row">
                                                                    {{ form |crispy}}
                                                                    <button type="button" class="btn btn-danger remove-form-btn">Remove</button>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <button type="button" id="add-form-btn" class="btn btn-primary">Add another</button>
                                                <button type="submit" class="btn btn-success">Submit</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const addBtn = document.getElementById('add-form-btn');
            const formsetContainer = document.getElementById('formset-container');
            const totalForms = document.getElementById('id_{% for inline_formset in inline_formsets %}{{ inline_formset.prefix }}{% endfor %}-TOTAL_FORMS');
    
            // Function to update the form index of each form in the formset
            const updateFormIndexes = () => {
                const forms = formsetContainer.querySelectorAll('.form-group');
                forms.forEach((form, index) => {
                    Array.from(form.querySelectorAll('input, select, textarea, label')).forEach((element) => {
                        const name = element.getAttribute('name');
                        const id = element.getAttribute('id');
                        const forAttribute = element.getAttribute('for');
                        if (name) element.setAttribute('name', name.replace(/-\d+-/, `-${index}-`));
                        if (id) element.setAttribute('id', id.replace(/-\d+-/, `-${index}-`));
                        if (forAttribute) element.setAttribute('for', forAttribute.replace(/-\d+-/, `-${index}-`));
                    });
                });
            };
    
            // Add form
            addBtn.addEventListener('click', () => {
                const newForm = formsetContainer.querySelector('.form-group').cloneNode(true);
                const formRegex = RegExp(`-${totalForms.value}-`, 'g');
                
                newForm.innerHTML = newForm.innerHTML.replace(formRegex, `-${parseInt(totalForms.value)}-`);
                formsetContainer.appendChild(newForm);
    
                totalForms.setAttribute('value', `${parseInt(totalForms.value) + 1}`);
                updateFormIndexes();
            });
    
            // Remove form
            formsetContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-form-btn')) {
                    e.target.closest('.form-group').remove();
                    totalForms.setAttribute('value', `${parseInt(totalForms.value) - 1}`);
                    updateFormIndexes();
                }
            });
        });
    </script>
{% endblock %}